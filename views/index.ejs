<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/index.css" />
    <link rel="stylesheet" href="/css/notes.css" />
    <title>WebNotes</title>
    <!-- Accessibility Enhancements -->
    <style>
      /* Responsive Design Enhancements */
      @media (max-width: 600px) {
        .column_2 {
          width: 100%;
        }
        .plusBTN {
          position: fixed;
          bottom: 20px;
          right: 20px;
        }
      }
      /* Toast Notification Styles */
      .toast {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 2px;
        padding: 16px;
        position: fixed;
        z-index: 1;
        left: 50%;
        bottom: 30px;
        font-size: 17px;
      }

      .toast.show {
        visibility: visible;
        -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }

      @-webkit-keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @-webkit-keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 60px;
          opacity: 0;
        }
      }

      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 60px;
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="background">
      <div class="shape"></div>
      <div class="shape"></div>
    </div>

    <div id="container">
      <div class="header">
        <div class="headerTitle">WebNotes</div>
        <div class="userSection">
          <div class="userName">
            <span class="userIcon">üë§</span>
            <span class="userText"><%= user.username %></span>
          </div>
          <div class="logout_btn">
            <a href="/logout" class="logout_link">Kijelentkez√©s</a>
          </div>
        </div>
      </div>
    </div>

    <div id="container2">
      <div class="row">
        <div class="column_1"></div>
        <div class="column_2">
          <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Jegyzetek keres√©se..." aria-label="Jegyzetek keres√©se" />
          </div>
          <div id="noteList"></div>
        </div>
        <div class="column_3">
          <button class="plusBTN" onclick="openNoteModal()" aria-label="√öj jegyzet hozz√°ad√°sa">+</button>
        </div>
      </div>
    </div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="noteModalLabel">
      <div class="modal-content">
        <input type="text" id="noteTitle" placeholder="C√≠m" aria-label="Jegyzet c√≠me" />
        <textarea id="noteContent" placeholder="Tartalom" rows="5" aria-label="Jegyzet tartalma"></textarea>

        <!-- Tag Input Section -->
        <div class="tag-container" id="tagContainer"></div>
        <input type="text" id="tagInput" class="tag-input" placeholder="Add hozz√° a c√≠mk√©ket (vessz≈ëvel elv√°lasztva)" aria-label="C√≠mk√©k hozz√°ad√°sa" />

        <div class="modal-buttons">
          <button class="modal-save" onclick="saveNote()">Ment√©s</button>
          <button class="modal-cancel" onclick="closeNoteModal()">M√©gse</button>
        </div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <!-- Place the first <script> tag in your HTML's <head> -->
    <script src="https://cdn.jsdelivr.net/npm/hugerte@1.0.4/hugerte.min.js"></script>
    <script>
      hugerte.init({
        selector: "textarea",
        plugins: [
          "anchor","autolink","charmap","codesample","emoticons","image","link","lists","media","searchreplace","table","visualblocks","wordcount",
        ],
        toolbar: "undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat",
        tinycomments_mode: "embedded",
        toolbar: "language",
        spellchecker_language: "hu",
      })

      let notes = []
      let editingId = null

      function sanitizeInput(input) {
        const tempDiv = document.createElement("div")
        tempDiv.textContent = input || ''
        return tempDiv.innerHTML
      }

      function showToast(message) {
        const toast = document.getElementById("toast")
        toast.textContent = message
        toast.className = "toast show"
        setTimeout(() => { toast.className = toast.className.replace("show", "") }, 3000)
      }

      function openNoteModal(noteId = null) {
        const modal = document.getElementById("noteModal")
        const titleInput = document.getElementById("noteTitle")
        const contentInput = document.getElementById("noteContent")
        const tagContainer = document.getElementById("tagContainer")
        const tagInput = document.getElementById("tagInput")

        if (noteId !== null) {
          const id = Number(noteId)
          editingId = id
          const note = notes.find(n => Number(n.id) === id)
          if (note) {
            titleInput.value = note.title || ''
            if (window.tinymce) {
              const ed = tinymce.get('noteContent') || tinymce.activeEditor
              if (ed && typeof ed.setContent === 'function') ed.setContent(note.content || '')
              else contentInput.value = note.content || ''
            } else {
              contentInput.value = note.content || ''
            }
            tagContainer.innerHTML = ""
            ;(note.tags || []).forEach((tag) => createTagElement(tag))
          } else {
            editingId = null
            titleInput.value = ''
            if (window.tinymce) { const ed = tinymce.get('noteContent') || tinymce.activeEditor; if (ed && typeof ed.setContent === 'function') ed.setContent('') }
            else contentInput.value = ''
            tagContainer.innerHTML = ''
          }
        } else {
          editingId = null
          titleInput.value = ''
          if (window.tinymce) { const ed = tinymce.get('noteContent') || tinymce.activeEditor; if (ed && typeof ed.setContent === 'function') ed.setContent('') }
          else document.getElementById('noteContent').value = ''
          tagContainer.innerHTML = ''
          tagInput.value = ''
        }

        modal.style.display = 'block'
        titleInput.focus()
      }

      function createTagElement(tagText) {
        const tagContainer = document.getElementById('tagContainer')
        const tagElement = document.createElement('div')
        tagElement.classList.add('tag')
        tagElement.innerHTML = `${sanitizeInput(tagText)} <span class="tag-delete" onclick="deleteTag(this)" aria-label="C√≠mke t√∂rl√©se">‚úñ</span>`
        tagContainer.appendChild(tagElement)
      }

      function deleteTag(deleteButton) { deleteButton.closest('.tag').remove() }

      document.getElementById('tagInput').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault()
          const tagText = this.value.trim()
          if (tagText) {
            const existingTags = Array.from(document.querySelectorAll('.tag')).map(t => t.textContent.trim().replace('‚úñ', ''))
            if (!existingTags.includes(tagText)) { createTagElement(tagText); this.value = '' } else alert('Ez a c√≠mke m√°r l√©tezik!')
          }
        }
      })

      async function saveNote() {
        const title = document.getElementById('noteTitle').value.trim()
        if (window.tinymce && typeof tinymce.triggerSave === 'function') tinymce.triggerSave()
        let content = document.getElementById('noteContent').value.trim()
        if (window.tinymce) {
          const ed = tinymce.get('noteContent') || tinymce.activeEditor
          if (ed) {
            const txt = ed.getContent({ format: 'text' }).trim() || ed.getContent().trim()
            if (txt) content = txt
          }
        }
        if (!content) {
          const iframe = document.querySelector('.tox-edit-area iframe')
          if (iframe && iframe.contentDocument) {
            const body = iframe.contentDocument.body
            if (body) {
              const txt = body.innerText.trim() || body.innerHTML.trim()
              if (txt) content = txt
            }
          }
        }

        const tags = Array.from(document.querySelectorAll('.tag')).map((tag) => tag.textContent.trim().replace('‚úñ', ''))
        let note
        if (editingId !== null) {
          const original = notes.find(n => Number(n.id) === editingId)
          note = { id: editingId, title, content, tags, createdAt: original ? original.createdAt : new Date().toISOString(), updatedAt: new Date().toISOString() }
        } else {
          note = { title, content, tags, createdAt: new Date().toISOString() }
        }

        console.log('saveNote payload', note)
        if (!note.title || !note.content) { alert('A c√≠m √©s a tartalom mez≈ëk kit√∂lt√©se k√∂telez≈ë!'); return }

        try {
          const response = await fetch('/notes/save', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ notes: [note] }) })
          const respData = await response.json().catch(() => null)
          console.log('save response summary:', respData && respData.notes ? respData.notes.map(n => ({ id: n.id, len: n.content ? n.content.length : 0 })) : respData)
          if (!response.ok) { let errMsg = 'Hiba t√∂rt√©nt a ment√©s sor√°n.'; if (respData && respData.message) errMsg = respData.message; throw new Error(errMsg) }

          if (respData && Array.isArray(respData.notes)) { notes = respData.notes; renderNotes(notes) } else { await loadNotes() }

          editingId = null
          closeNoteModal()
          showToast('Jegyzet sikeresen mentve!')
        } catch (err) { console.error('saveNote error', err); alert(err.message) }
      }

      async function deleteNoteById(noteId) {
        if (!confirm('Biztosan t√∂rli a jegyzetet?')) return
        try {
          const response = await fetch('/notes/delete', { method: 'POST', credentials: 'same-origin', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: noteId }) })
          if (response.ok) {
            const idx = notes.findIndex(n => Number(n.id) === Number(noteId)); if (idx !== -1) notes.splice(idx, 1)
            renderNotes()
            showToast('Jegyzet sikeresen t√∂r√∂lve!')
          } else throw new Error('Hiba t√∂rt√©nt a t√∂rl√©s sor√°n.')
        } catch (error) { alert(error.message) }
      }

      function renderNotes(list = notes) {
        notes = list
        const noteList = document.getElementById('noteList')
        noteList.innerHTML = ''
        if (!notes || notes.length === 0) { noteList.innerHTML = "<div class='no-notes'>Nincsenek jegyzetek.</div>"; return }
        notes.forEach((n) => {
          const card = document.createElement('div')
          card.className = 'note-card'
          card.innerHTML = `
            <h3>${sanitizeInput(n.title)}</h3>
            <p>${sanitizeInput(n.content)}</p>
            <div class="tag-row">${(n.tags || []).map(t=>`<span class="tag">${sanitizeInput(t)}</span>`).join('')}</div>
            <div class="note-actions">
              <button class="edit-btn" onclick="openNoteModal(${n.id})" aria-label="Szerkeszt√©s">‚úé</button>
              <button class="delete-btn" onclick="deleteNoteById(${n.id})" aria-label="T√∂rl√©s">üóë</button>
            </div>
          `
          noteList.appendChild(card)
        })
      }

      document.getElementById('searchInput').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase()
        const filteredNotes = notes.filter((note) => (note.title || '').toLowerCase().includes(searchTerm) || (note.content || '').toLowerCase().includes(searchTerm) || (note.tags || []).some((tag) => tag.toLowerCase().includes(searchTerm)))
        renderNotes(filteredNotes)
      })

      async function loadNotes() {
        try {
          const response = await fetch('/notes/list', { credentials: 'same-origin' })
          if (response.ok) { const result = await response.json(); notes = result.notes || []; renderNotes(notes) } else throw new Error('Hiba t√∂rt√©nt a jegyzetek bet√∂lt√©se sor√°n.')
        } catch (error) { alert(error.message) }
      }

      function closeNoteModal() { const modal = document.getElementById('noteModal'); modal.style.display = 'none'; editingId = null }

      window.onclick = function (event) { const modal = document.getElementById('noteModal'); if (event.target === modal) closeNoteModal() }

      document.addEventListener('DOMContentLoaded', function () { loadNotes() })
    </script>
  </body>
</html>
