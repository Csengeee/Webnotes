<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/index.css" />
    <link rel="stylesheet" href="/css/notes.css" />
    <title>WebNotes</title>
    <style>
      /* Responsive √©s Toast st√≠lusok v√°ltozatlanok */
      @media (max-width: 600px) {
        .column_2 { width: 100%; }
        .plusBTN { position: fixed; bottom: 20px; right: 20px; }
      }
      .toast {
        visibility: hidden; min-width: 250px; margin-left: -125px;
        background-color: #333; color: #fff; text-align: center;
        border-radius: 5px; padding: 16px; position: fixed;
        z-index: 999; left: 50%; bottom: 30px; font-size: 17px;
      }
      .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
      @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
      @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 60px; opacity: 0; } }
    </style>
  </head>
  <body>
    <div class="background">
      <div class="shape"></div>
      <div class="shape"></div>
    </div>

    <div id="container">
      <div class="header">
        <div class="headerTitle">WebNotes</div>
        <div class="userSection">
          <div class="userName">
            <span class="userIcon">üë§</span>
            <span class="userText"><%= user.username %></span>
          </div>
          <div class="logout_btn">
            <a href="/logout" class="logout_link">Kijelentkez√©s</a>
          </div>
        </div>
      </div>
    </div>

    <div id="container2">
      <div class="row">
        <div class="column_1"></div>
        <div class="column_2">
          <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Jegyzetek keres√©se..." aria-label="Jegyzetek keres√©se" />
          </div>
          <div id="noteList"></div>
        </div>
        <div class="column_3">
          <button id="addNoteBtn" class="plusBTN" onclick="openNoteModal()" aria-label="√öj jegyzet hozz√°ad√°sa">+</button>
        </div>
      </div>
    </div>

    <div id="noteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="noteModalLabel">
      <div class="modal-content">
        <input type="text" id="noteTitle" placeholder="C√≠m" aria-label="Jegyzet c√≠me" />
        <textarea id="noteContent" placeholder="Tartalom" rows="5" aria-label="Jegyzet tartalma"></textarea>
        <div class="tag-container" id="tagContainer"></div>
        <input type="text" id="tagInput" class="tag-input" placeholder="C√≠mk√©k (vessz≈ë vagy Enter)" aria-label="C√≠mk√©k hozz√°ad√°sa" />
        <div class="modal-buttons">
          <button class="modal-save" onclick="saveNote()">Ment√©s</button>
          <button class="modal-cancel" onclick="closeNoteModal()">M√©gse</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hugerte@1.0.4/hugerte.min.js"></script>
    <script>
      let notes = [];
      let editingId = null;

      hugerte.init({
        selector: "#noteContent",
        plugins: ["lists", "link", "image", "table", "wordcount"],
        toolbar: "undo redo | bold italic | alignleft aligncenter alignright | bullist numlist",
        setup: function (editor) { editor.on('change', function () { editor.save(); }); }
      });

      function showToast(message) {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "toast show";
        setTimeout(() => { toast.className = "toast"; }, 3000);
      }

      function openNoteModal(noteId = null) {
        const modal = document.getElementById("noteModal");
        const titleInput = document.getElementById("noteTitle");
        const tagContainer = document.getElementById("tagContainer");
        const tagInput = document.getElementById("tagInput");
        
        tagContainer.innerHTML = "";
        tagInput.value = "";

        if (noteId !== null) {
          editingId = Number(noteId);
          const note = notes.find(n => Number(n.id) === editingId);
          if (note) {
            titleInput.value = note.title;
            hugerte.get('noteContent').setContent(note.content || "");
            (note.tags || []).forEach(tag => createTagElement(tag));
          }
        } else {
          editingId = null;
          titleInput.value = "";
          hugerte.get('noteContent').setContent("");
        }

        modal.style.display = 'block';
        titleInput.focus();
      }

      function closeNoteModal() {
        document.getElementById('noteModal').style.display = 'none';
        document.getElementById('addNoteBtn').focus();
        editingId = null;
      }

      function createTagElement(tagText) {
        const tagContainer = document.getElementById('tagContainer');
        const tagElement = document.createElement('div');
        tagElement.classList.add('tag');
        tagElement.innerHTML = `${DOMPurify.sanitize(tagText)} <span class="tag-delete" onclick="this.parentElement.remove()" aria-label="C√≠mke t√∂rl√©se">‚úñ</span>`;
        tagContainer.appendChild(tagElement);
      }

      document.getElementById('tagInput').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ',') {
          e.preventDefault();
          const tagText = this.value.trim().replace(',', '');
          if (tagText) {
            const existing = Array.from(document.querySelectorAll('.tag')).map(t => t.textContent.trim().replace('‚úñ', '').trim());
            if (!existing.includes(tagText)) {
              createTagElement(tagText);
              this.value = '';
            } else {
              showToast('Ez a c√≠mke m√°r l√©tezik!');
            }
          }
        }
      });

      async function saveNote() {
        const title = document.getElementById('noteTitle').value.trim();
        const content = hugerte.get('noteContent').getContent().trim();
        const tags = Array.from(document.querySelectorAll('.tag')).map(t => t.textContent.trim().replace('‚úñ', '').trim());

        if (!title || !content) {
          showToast('A c√≠m √©s a tartalom kit√∂lt√©se k√∂telez≈ë!');
          return;
        }

        const note = { id: editingId, title, content, tags };
        
        try {
          const response = await fetch('/notes/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: [note] })
          });

          if (!response.ok) throw new Error('Hiba a ment√©s sor√°n');
          
          const respData = await response.json();
          notes = respData.notes;
          renderNotes();
          closeNoteModal();
          showToast('Sikeres ment√©s!');
        } catch (err) {
          showToast(err.message);
        }
      }

      function renderNotes(list = notes) {
        const noteList = document.getElementById('noteList');
        noteList.innerHTML = list.length ? '' : '<div class="no-notes">Nincsenek jegyzetek.</div>';
        
        list.forEach(n => {
          const card = document.createElement('div');
          card.className = 'note-card';
          // DOMPurify haszn√°lata az XSS ellen, hogy a form√°z√°sok megmaradjanak
          card.innerHTML = `
            <h3>${DOMPurify.sanitize(n.title)}</h3>
            <div class="note-body">${DOMPurify.sanitize(n.content)}</div>
            <div class="tag-row">${(n.tags || []).map(t => `<span class="tag">${DOMPurify.sanitize(t)}</span>`).join('')}</div>
            <div class="note-actions">
              <button class="edit-btn" onclick="openNoteModal(${n.id})">‚úé</button>
              <button class="delete-btn" onclick="deleteNoteById(${n.id})">üóë</button>
            </div>
          `;
          noteList.appendChild(card);
        });
      }

      async function deleteNoteById(id) {
        if (!confirm('Biztosan t√∂rl√∂d?')) return;
        try {
          const res = await fetch('/notes/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
          });
          if (res.ok) {
            notes = notes.filter(n => n.id !== id);
            renderNotes();
            showToast('T√∂r√∂lve!');
          }
        } catch (err) { showToast('Hiba a t√∂rl√©sn√©l'); }
      }

      async function loadNotes() {
        try {
          const res = await fetch('/notes/list');
          const data = await res.json();
          notes = data.notes || [];
          renderNotes();
        } catch (err) { console.error(err); }
      }

      document.getElementById('searchInput').addEventListener('input', function() {
        const val = this.value.toLowerCase();
        const filtered = notes.filter(n => 
          n.title.toLowerCase().includes(val) || 
          n.content.toLowerCase().includes(val) ||
          n.tags.some(t => t.toLowerCase().includes(val))
        );
        renderNotes(filtered);
      });

      document.addEventListener('DOMContentLoaded', loadNotes);
      window.onclick = (e) => { if (e.target == document.getElementById('noteModal')) closeNoteModal(); };
    </script>
  </body>
</html>